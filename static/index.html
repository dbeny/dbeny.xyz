<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Marci Hajonéz Freak-wiki</title>
		<meta name="theme-color" content="#309ffa">
		<meta name="description"
			content="Mert itt a vég tudománya (tényleg) amit még törött szemhéjjal se nyunyálsz. Végső nyugovóra tér a hasznos orrú nyugágy, amickor a lenyélő bandó remeg. A itt találod a forgókeverék hasznosságának funkcióját és. Veszíthetetlen pitélytárház és kollektív kacagó.">
		<meta name="image" content="https://github.com/dbeny/dbeny.xyz/blob/main/torjonel.png">
		<meta property="og:image" content="https://github.com/dbeny/dbeny.xyz/blob/main/torjonel.png">
		<link rel="stylesheet" href="/style.css">
		<link rel="stylesheet"
			href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=open_in_new" />
		<link rel="shortcut icon"
			href="https://cdn.discordapp.com/attachments/899955220468097065/1374635704922935356/picy.png?ex=682ec4c3&is=682d7343&hm=e91fe9a6ff250a3bbb8021f94c715a37138e4d12b72e6ae5b9b861758eb8c6f6&"
			type="image/png">
		<link rel="icon"
			href="https://cdn.discordapp.com/attachments/899955220468097065/1374635704922935356/picy.png?ex=682ec4c3&is=682d7343&hm=e91fe9a6ff250a3bbb8021f94c715a37138e4d12b72e6ae5b9b861758eb8c6f6&"
			type="image/png">
	</head>
	<body>
		<div class="main-container">
			<div class="main">
				<h1>í komikus balsors kalkulátor</h1>
				<div class="kardos-container">
					<span>Új év új kormány új kardos régi espero</span>
					<h4 id="time">
						<div id="d">00</div>:<div id="h">00</div>:<div id="m">00</div>:<div id="s">00</div>
					</h4>
					<span class="smalltxt">amugy ez csak az ujevet mutatja</span>
					<span>Aktuális választások:</span>
					<h4>
						<span id="dd">00</span>:<span id="hh">00</span>:<span id="mm">00</span>:<span
							id="ss">00</span><br />
					</h4>
					<br>
					<span>Genezis dátum: <h4 id="created-at"></h4></span>
					<span>Ultima edício: <h4 id="edited-at"></h4></span>
					<br>
					<span>Megjelenő megőig megtétel:</span>
					<h4>
						<span id="ddd">00</span>:<span id="hhh">00</span>:<span id="mmm">00</span>:<span
							id="sss">00</span><br />
					</h4>
					<span class="smalltxt" id="symmetric"></span>
					<br>
					<span>Ily időben regisztráltam mestermcre: <h4 id="mestermc"></h4></span>
					<span>Unix időbélyeg: <h4 id="unix"></h4></span>
					<span>Fém: <h4 id="metallica"></h4></span>
					<br>
					<span>Kardos ennyi ideje :HOMÁR: <h4 id="kardos"></h4></span>
				</div>
			</div>
			<div class="ragebait">
				<h1>the silence is the ragebait itself</h1>
				<ul>
					Boatman? - I'll be there!<br>
					Brickman? - I'll be there!<br>
					Little German? - I'll be there!<br>
					Slinky? - I'll be there!<br>
					Judge? - I'll be there!<br>
					Snowy? - I'll be there!<br>
					Trick? - I'll be there!<br>
					Hillman? - I'll be there!<br>
					Ankle? - I'll be there!<br>
				</ul>
				<span>Csimpákoló nyitralók és boka aki fekete fekete bokája → ₯ (srác tökély)<br>Praktikus világklasszis
					bottle (üveg)</span><br>
				<div class="mogging">
					<img src="/imgs/mog.gif" alt=""><br>
					you rn
				</div>
				túl sok a kacaj (hahota)
			</div>
			<div class="side-container">
				<div class="side">
					<h1>In the case of stupidity</h1>
					<div class="red">
						<h5>Maybe you wanted to go the 2nd best ragebait site:</h5>
						<a href="https://fv.dbeny.xyz" target="_blank">Formula V Website <span
								class="material-symbols-outlined">open_in_new</span></a>
					</div>
				</div>
				<div class="describe">
					<div class="red">
						<h1>Ezek vagytok mi</h1>
						<h3>a grund homályában</h3>
					</div>
					<p>Mert itt a vég tudománya (tényleg) amit még törött szemhéjjal se nyunyálsz. Végső nyugovóra tér a
						hasznos orrú nyugágy, amickor a lenyélő bandó remeg. A itt találod a forgókeverék hasznosságának
						funkcióját és. Veszíthetetlen pitélytárház és kollektív kacagó.</p>
				</div>
			</div>
		</div>
		<div class="dts">
			<div id="admin" class="hidden">
				Látod?
			</div>
			<div class="ctx">
				<h1>Dani és Beni padja type shit</h1>
				<h3>Context: nem kapsz (ott van a cnc mogott)</h3>
			</div>
			<ul></ul>
			<div class="footer">
				<span>:BandiOfUndying: Made by Ben and Soviaat :catWow:</span>
				<button onclick="window.location='/auth/discord'" id="dash" class="hidden">Dashboard</button>
				<div class="admin_button" onclick="setAdminOpen()">Edit</div>
			</div>
			<script src="/script.js"></script>
		</div>
		<script>
			async function checkAuth() {
				const res = await fetch('/auth/check');
				const data = await res.json().catch(e => { console.error('auth json parse', e); return {}; });
				return Boolean(data.authenticated);
			}

			// strips leading spaces/tabs from each line, preserves \n, returns '' for null/undefined
			const stripLeftEachLine = s => {
				if (s == null) return '';
				return String(s).replace(/\r\n/g, '\n').replace(/^[ \t]+/gm, '');
			};

			// small helper to check non-empty string
			const hasText = v => v != null && String(v).trim() !== '';

			// safer version of renderPosts with debugging & guards
			async function renderPosts() {
				try {
					const res = await fetch('/posts/fetch');
					if (!res.ok) {
						console.error('fetch /posts/fetch failed', res.status, res.statusText);
						return;
					}

					const data = await res.json().catch(e => { console.error('parse posts json', e); return null; });
					console.log('raw fetched data:', data);

					if (!Array.isArray(data)) {
						console.error('expected array from /posts/fetch, got:', data);
						return;
					}

					const ul = document.querySelector('.dts ul');
					ul.innerHTML = '';

					const last100 = data.slice(-100);
					console.log('rendering last100 length=', last100.length, last100);

					last100.forEach((p, idx) => {
						try {
							const li = document.createElement('li');
							li.style.whiteSpace = 'pre-wrap'; // render \n as line breaks

							// defensive: p might be null/undefined
							if (!p || typeof p !== 'object') {
								console.warn('skipping invalid post at index', idx, p);
								ul.appendChild(li);
								return;
							}

							// normalize raw pieces
							const before = p.content_before ?? null;
							const after = p.content_after ?? null;
							const image = (p.image !== undefined && p.image !== null && String(p.image).trim() !== '') ? String(p.image) : null;

							const beforeText = before && before.text != null ? stripLeftEachLine(before.text) : '';
							const afterText = after && after.text != null ? stripLeftEachLine(after.text) : '';

							const hasBefore = before && hasText(beforeText);
							const hasAfter = after && hasText(afterText);
							const hasImage = !!image;

							// debug every item a tiny bit
							console.debug('post', idx, { hasBefore, hasImage, hasAfter, isReply: Boolean(before && before.is_reply) });

							// REPLY short-circuit (guard before.is_reply)
							if (before && before.is_reply) {
								const emptyDiv = document.createElement('div');
								const divider = document.createElement('span');
								divider.classList.add('replied');
								li.classList.add('reply');

								emptyDiv.style.whiteSpace = 'pre-wrap';
								emptyDiv.appendChild(document.createTextNode(beforeText)); // safe: text node

								emptyDiv.prepend(divider);
								li.appendChild(emptyDiv);
								ul.appendChild(li);
								return;
							}

							// 1) before exists, no image, no after -> only before text
							if (hasBefore && !hasImage && !hasAfter) {
								// innerText would work too, but createTextNode is safe
								li.appendChild(document.createTextNode(beforeText));
								ul.appendChild(li);
								return;
							}

							// 2) before + image, no after -> before text then image
							if (hasBefore && hasImage && !hasAfter) {
								li.appendChild(document.createTextNode(beforeText));
								const img = document.createElement('img');
								img.src = image;
								li.appendChild(img);
								ul.appendChild(li);
								return;
							}

							// 3) image + after, no before -> image then after text
							if (!hasBefore && hasImage && hasAfter) {
								const img = document.createElement('img');
								img.src = image;
								li.appendChild(img);
								// small separation then text node (preserves \n)
								li.appendChild(document.createTextNode('\n' + afterText));
								ul.appendChild(li);
								return;
							}

							// 4) before + image + after -> before, image, after
							if (hasBefore && hasImage && hasAfter) {
								li.appendChild(document.createTextNode(beforeText));
								const img = document.createElement('img');
								img.src = image;
								li.appendChild(img);
								li.appendChild(document.createTextNode('\n' + afterText));
								ul.appendChild(li);
								return;
							}

							// fallbacks:
							// only after
							if (!hasBefore && !hasImage && hasAfter) {
								li.appendChild(document.createTextNode(afterText));
								ul.appendChild(li);
								return;
							}

							// only image
							if (!hasBefore && hasImage && !hasAfter) {
								const img = document.createElement('img');
								img.src = image;
								li.appendChild(img);
								ul.appendChild(li);
								return;
							}

							// only before (catch-all)
							if (hasBefore) {
								li.appendChild(document.createTextNode(beforeText));
								ul.appendChild(li);
								return;
							}

							// otherwise append empty li
							ul.appendChild(li);
						} catch (innerErr) {
							console.error('error rendering post at index', idx, innerErr);
						}
					});

				} catch (err) {
					console.error('renderPosts failed', err);
				}
			}

			// admin / auth bits unchanged
			let adminOpen = false;
			let isAuthenticated = false;

			function setAdminOpen() {
				adminOpen = !adminOpen;
				console.log(`admin: ${adminOpen}`);
				refreshAdmin();
			}

			async function refreshAuth() {
				isAuthenticated = await checkAuth();

				const login = document.getElementById("dash");
				if (isAuthenticated) login.classList.add("hidden");
				else login.classList.remove("hidden");
			}

			function refreshAdmin() {
				const adminDiv = document.getElementById('admin');
				if (isAuthenticated && adminOpen) adminDiv.classList.remove('hidden');
				else adminDiv.classList.add('hidden');
			}

			async function init() {
				await refreshAuth();
				refreshAdmin();
				renderPosts();
			}

			init();
		</script>
	</body>
</html>